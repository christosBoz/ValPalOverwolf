<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Client Activation</title>
</head>
<body>
    <button id="activate-button">Activate Client</button>
    <pre id="activation-status"></pre>

    <script type="module">
        let puuid = '';
        document.addEventListener('DOMContentLoaded', async () => {
            const activateButton = document.getElementById('activate-button');
            const activationStatusPre = document.getElementById('activation-status');

            activateButton.addEventListener('click', async () => {
                try {
                    // Adjust the path to your actual lockfile path
                    const lockfilePath = 'C:/Users/majdh/AppData/Local/Riot Games/Riot Client/Config/lockfile'; // Change this to the actual path

                    // Read the lockfile content
                    const lockfileContent = await new Promise((resolve, reject) => {
                        overwolf.io.readTextFile(lockfilePath, { encoding: 'utf8' }, (result) => {
                            if (result.success) {
                                resolve(result.content);
                            } else {
                                reject(new Error('Failed to read lockfile: ' + result.error));
                            }
                        });
                    });

                    const [name, pid, port, password, protocol] = lockfileContent.split(':');

                    // Base64 encode the credentials as required
                    const base64Credentials = btoa(`riot:${password}`);

                    // Setup the headers using the extracted password
                    const localHeaders = {
                        'Authorization': `Basic ${base64Credentials}`
                    };

                    // Fetch chat session data from the local endpoint using the extracted port
                    const sessionResponse = await fetch(`https://127.0.0.1:${port}/chat/v1/session`, {
                        method: 'GET',
                        headers: localHeaders
                    });

                    if (!sessionResponse.ok) {
                        throw new Error('Failed to fetch chat session data');
                    }

                    const sessionData = await sessionResponse.json();

                    // Fetch entitlements token from the local endpoint
                    const entitlementsResponse = await fetch(`https://127.0.0.1:${port}/entitlements/v1/token`, {
                        method: 'GET',
                        headers: localHeaders
                    });

                    if (!entitlementsResponse.ok) {
                        throw new Error('Failed to fetch entitlements token');
                    }

                    const entitlementsData = await entitlementsResponse.json();
                    console.log(entitlementsData);

                    // Send the lockfile content, session data, and entitlements token to the Python server
                    const response = await fetch('http://ec2-3-22-235-94.us-east-2.compute.amazonaws.com:5000//activate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            lockfileContent,
                            sessionData,
                            entitlementsData // Include the fetched entitlements data
                        }),
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const result = await response.json();
                    activationStatusPre.textContent = `Success: ${JSON.stringify(result, null, 2)}`;

                    puuid = result.puuid;
                    localStorage.setItem('puuid', puuid);

                    // Refresh inventory if not already available in localStorage
                    const userInventory = localStorage.getItem(`${puuid}_inventory`);
                    if (userInventory === null) {
                        try {
                            const refreshResponse = await fetch(`http://ec2-3-22-235-94.us-east-2.compute.amazonaws.com:5000//refresh-inventory?puuid=${puuid}`);
                            if (!refreshResponse.ok) {
                                throw new Error('Failed to refresh inventory');
                            }
                            const refreshData = await refreshResponse.json();
                            localStorage.setItem(`${puuid}_inventory`, JSON.stringify(refreshData));

                            // Redirect to index.html after inventory is successfully loaded
                            window.location.href = 'index.html';
                        } catch (error) {
                            console.error('Error refreshing inventory:', error);
                            activationStatusPre.textContent += `\nError refreshing inventory: ${error.message}`;
                        }
                    } else {
                        // Redirect if inventory is already present
                        window.location.href = 'index.html';
                    }
                } catch (error) {
                    activationStatusPre.textContent = `Error: ${error.message}`;
                }
            });
        });
    </script>
</body>
</html>
